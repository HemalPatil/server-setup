Aim: Get IMAP server working so mails can be accessed using clients like GMail, Thunderbird, Outlook, etc.


Assumptions:
    Postfix is installed and is able to send and receive mails
    MySQL 8 is installed
    Certbot (Let's encrypt) SSL certificates and private keys available.
        Stored at:
            /path/to/cert.pem
            /path/to/private_key.pem
    You setup Postfix and MySQL using steps mentioned in this guide.
        i.e.:
            Aliases mapped using /etc/postfix/virtual


Open port 25 (SMTP), 143 (IMAP), 465 (SMTPS), 587 (SMTP submission), 993 (IMAPS)
    If you're on AWS, update the security group


Install:
    sudo apt install postfix postfix-mysql dovecot-core dovecot-imapd dovecot-lmtpd dovecot-mysql


Setup database and tables:
    CREATE USER 'mailuser'@'127.0.0.1' IDENTIFIED BY 'dbpassword';
    CREATE DATABASE servermail;
    GRANT SELECT ON servermail.* TO 'mailuser'@'127.0.0.1';
    FLUSH PRIVILEGES;
    USE servermail;

    CREATE TABLE `virtual_domains` (`id` INT NOT NULL AUTO_INCREMENT, `name` VARCHAR(50) NOT NULL, PRIMARY KEY (`id`)) DEFAULT CHARSET=utf8;
    CREATE TABLE `virtual_users` (`id` INT NOT NULL AUTO_INCREMENT, `domain_id` INT NOT NULL, `password` VARCHAR(512) NOT NULL, `email` VARCHAR(120) NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `email` (`email`), FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE) DEFAULT CHARSET=utf8;
        Note: make sure the password is wide enough to hold sha512 string since we store passwords generated by dovecot's SSHA512 (Salted SHA512).

    INSERT INTO `servermail`.`virtual_domains` (`id` ,`name`) VALUES ('1', 'example.com');

    Run:
        The algorithm to generate password is SSHA512(pass, salt) = SHA512(pass + salt) + salt
        It's better to use doveadm to generate password than generate it manually.

        doveadm pw -s SSHA512 -p myuserspassword
        {SSHA512}SomeBase64EncodedString++++++vfAeXcHDZa6xW+++++++++PXmBcRRIXufELhQ74BL/+bLFFyBFc=

        Store the string after {SSHA512} and use it in the next step

    INSERT INTO `servermail`.`virtual_users`
    (`id`, `domain_id`, `password` , `email`)
    VALUES
    ('1', '1', 'SomeBase64EncodedString++++++vfAeXcHDZa6xW+++++++++PXmBcRRIXufELhQ74BL/+bLFFyBFc=', 'mail1@example.com'),
    ('2', '1', 'SomeBase64EncodedString++++++vfAeXcHDZa6xW+++++++++PXmBcRRIXufELhQ74BL/+bLFFyBFc=', 'mail2@example.com'),
    ('3', '1', 'SomeBase64EncodedString++++++vfAeXcHDZa6xW+++++++++PXmBcRRIXufELhQ74BL/+bLFFyBFc=', 'mail3@example.com');

        Note: all the mail IDs created using this hash will have the same password



POSTFIX setup
    Get backup:
        mkdir ~/postfix.bak
        cp /etc/postfix/main.cf ~/postfix.bak/
        cp /etc/postfix/master.cf ~/postfix.bak/

    /etc/postfix/main.cf:
        Change:
            myhostname = example.com
            mydestination = localhost
            smtpd_tls_cert_file=/path/to/cert.pem
            smtpd_tls_key_file=/path/to/private_key.pem

        Add:
            smtpd_use_tls = yes
            smtpd_tls_auth_only = yes
            smtpd_sasl_type = dovecot
            smtpd_sasl_path=private/auth
            smtpd_sasl_auth_enable=yes
            smtpd_recipient_restrictions=permit_sasl_authenticated permit_mynetworks reject_unauth_destination
            virtual_transport = lmtp:unix:private/dovecot-lmtp
            virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
            virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf

    Create sudo vi /etc/postfix/mysql-virtual-mailbox-domains.cf:
        user = mailuser
        password = dbpassword
        hosts = 127.0.0.1
        dbname = servermail
        query = SELECT 1 FROM virtual_domains WHERE name='%s'

    Create sudo vi /etc/postfix/mysql-virtual-mailbox-maps.cf:
        user = mailuser
        password = dbpassword
        hosts = 127.0.0.1
        dbname = servermail
        query = SELECT 1 FROM virtual_users WHERE email='%s'

    Modify sudo vi /etc/postfix/master.cf:
        Uncomment and add:
            submission inet n       -       y       -       -       smtpd
            -o syslog_name=postfix/submission
            -o smtpd_tls_security_level=encrypt
            -o smtpd_sasl_auth_enable=yes
            -o smtpd_client_restrictions=permit_sasl_authenticated,reject

    Verify:
        sudo systemctl restart postfix
        sudo systemctl status postfix
        postmap -q example.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
            Verifies if the domain conf file is picked up correctly. Should output 1 for all domains inserted in the virtual_domains table and no output for all other domains.
            Expected output: 1
        postmap -q mail1@example.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
        postmap -q mail3@example.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
            Verifies if the mailboxes conf file is picked up correctly. Should output 1 for all mails inserted in virtual_users that have a corresponding domain entry inserted in virtual_domains and no output for all other mails that don't satisfy that condition.
            Expected output: 1




Dovecot setup
    Create backup:
        mkdir ~/dovecot.bak
        cp /etc/dovecot/dovecot.conf ~/dovecot.bak/
        cp /etc/dovecot/conf.d/10-mail.conf ~/dovecot.bak/
        cp /etc/dovecot/conf.d/10-auth.conf ~/dovecot.bak/
        cp /etc/dovecot/conf.d/10-master.conf ~/dovecot.bak/
        cp /etc/dovecot/conf.d/10-ssl.conf ~/dovecot.bak/
        sudo cp /etc/dovecot/dovecot-sql.conf.ext ~/dovecot.bak/

    Verify /etc/dovecot/dovecot.conf with uncommented !include conf.d/*.conf   AND    !include_try /usr/share/dovecot/protocols.d/*.protocol:
        cat /etc/dovecot/dovecot.conf | grep -n include
        Make sure /usr/share/dovecot/protocols.d/*.protocol has IMAP and LMTP enabled

    Verify mail_location, mail_uid, mail_gid, mail_home
        cat /etc/dovecot/conf.d/10-mail.conf | grep -n mail_location
        mail_location = maildir:/home/ubuntu/Maildir
        cat /etc/dovecot/conf.d/10-mail.conf | grep -n mail_uid
        109:mail_uid = ubuntu
        cat /etc/dovecot/conf.d/10-mail.conf | grep -n mail_gid
        110:mail_gid = ubuntu
        cat /etc/dovecot/conf.d/10-mail.conf | grep -n mail_home
        24:mail_home = /home/ubuntu

    Verify mail_privileged_group = mail
        cat /etc/dovecot/conf.d/10-mail.conf | grep -n mail_priv
        115:mail_privileged_group = mail

    Verify 10-auth.conf
        cat /etc/dovecot/conf.d/10-auth.conf | grep -n disable_plaintext_auth
        10:disable_plaintext_auth = yes
        cat /etc/dovecot/conf.d/10-auth.conf | grep -n auth_mechanisms
        100:auth_mechanisms = plain login
        Comment:
            #!include auth-system.conf.ext
        Uncomment:
            !include auth-sql.conf.ext

    Verify /etc/dovecot/conf.d/auth-sql.conf.ext
        passdb
            driver sql
            args /etc/dovecot/dovecot-sql.conf.ext
        comment userdb


    Verify /etc/dovecot/dovecot-sql.conf.ext fields
        sudo cat /etc/dovecot/dovecot-sql.conf.ext | grep -n 'driver = mysql'
        32:driver = mysql
        74:connect = host=127.0.0.1 dbname=servermail user=mailuser password=dbpassword
        81:default_pass_scheme = SSHA512
        110:password_query = SELECT email as user, password FROM virtual_users WHERE email='%u';


    Verify /etc/dovecot/conf.d/10-master.conf fields
        17 service imap-login {
        18   inet_listener imap {
        19     port = 143
        20   }
        21   inet_listener imaps {
        22     port = 993
        23     ssl = yes
        24   }

        service lmtp {
        55   unix_listener /var/spool/postfix/private/dovecot-lmtp {
        56     mode = 0666
        57     user = postfix
        58     group = postfix
        59   }

        service auth {
        102   unix_listener /var/spool/postfix/private/auth {
        103     mode=0666
        104     user=postfix
        105     group=postfix
        106   }
        107   unix_listener auth-userdb {
        108     mode = 0600
        109     user = ubuntu
        110     group = ubuntu
        111   }
        120   user=dovecot
        121 }

        service auth-worker {
        128   user=ubuntu
        129 }


    Modify /etc/dovecot/conf.d/10-ssl.conf fields:
        ssl = required
        ssl_cert = </path/to/cert.pem
        ssl_key = </path/to/private_key.pem
        Note: Usually used the same certificate as the one used for postfix/smtpd. Never tried with different pair of certs and keys.
        Note: Important '<' character before the cert and key path.




Restart services:
    sudo systemctl restart postfix
    sudo systemctl restart dovecot
